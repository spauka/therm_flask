<div class="row">
  <div class="col-xs-12 col-sm-7 col-md-7 col-lg-4">
    <h1 class="page-title txt-color-blueDark">
      <i class="fa-solid fa-chart-area fa-fw "></i> 
        Thermometry 
        <span>>
        {{$route.current.scope.pagetitle}}
      </span>
    </h1>
  </div>
  <div class="col-xs-12 col-sm-5 col-md-5 col-lg-8">
    <ul id="sparks" class="">
      <!-- Will be filled in by JS below -->
   </ul>
  </div>
</div>

<script type="text/javascript">
  function init_sparkline(divid, data) {
    var $this = divid;
    var sparklineType = $this.data('sparkline-type');


    //LINE CHART
    if (sparklineType == 'line') {
      var sparklineHeight = $this.data('sparkline-height') || '30px';
      var sparklineWidth = $this.data('sparkline-width') || '90px';
      var thisLineColor = $this.data('sparkline-line-color') || $this.css('color') || '#0000f0';
      var thisLineWidth = $this.data('sparkline-line-width') || 1;
      var thisFill = $this.data('fill-color') || '#c0d0f0';
      var thisSpotColor = $this.data('sparkline-spot-color') || '#f08000';
      var thisMinSpotColor = $this.data('sparkline-minspot-color') || '#ed1c24';
      var thisMaxSpotColor = $this.data('sparkline-maxspot-color') || '#f08000';
      var thishighlightSpotColor = $this.data('sparkline-highlightspot-color') || '#50f050';
      var thisHighlightLineColor = $this.data('sparkline-highlightline-color') || 'f02020';
      var thisSpotRadius = $this.data('sparkline-spotradius') || 1.5;
      var thisChartMinYRange = $this.data('sparkline-min-y') || 'undefined'; 
      var thisChartMaxYRange = $this.data('sparkline-max-y') || 'undefined'; 
      var thisChartMinXRange = $this.data('sparkline-min-x') || 'undefined'; 
      var thisChartMaxXRange = $this.data('sparkline-max-x') || 'undefined'; 
      var thisMinNormValue = $this.data('min-val') || 'undefined'; 
      var thisMaxNormValue = $this.data('max-val') || 'undefined'; 
      var thisNormColor =  $this.data('norm-color') || '#c0c0c0';
      var thisDrawNormalOnTop = $this.data('draw-normal') || false;

      $this[0].sparkoptions = {
       type : 'line',
       width : sparklineWidth,
       height : sparklineHeight,
       lineWidth : thisLineWidth,
       lineColor : thisLineColor,
       fillColor : thisFill,
       spotColor : thisSpotColor,
       minSpotColor : thisMinSpotColor,
       maxSpotColor : thisMaxSpotColor,
       highlightSpotColor : thishighlightSpotColor,
       highlightLineColor : thisHighlightLineColor,
       spotRadius : thisSpotRadius,
       chartRangeMin : thisChartMinYRange,
       chartRangeMax : thisChartMaxYRange,
       chartRangeMinX : thisChartMinXRange,
       chartRangeMaxX : thisChartMaxXRange,
       normalRangeMin : thisMinNormValue,
       normalRangeMax : thisMaxNormValue,
       normalRangeColor : thisNormColor,
       drawNormalOnTop : thisDrawNormalOnTop
      };
      $this.sparkline(data, $this[0].sparkoptions);
    }
  }

function format_temp(temp, multiplier) {
  if (temp == null) {
    return "Und";
  }
  temp *= multiplier;
  if (temp > 100000) {
    temp = Math.round(temp);
    temp = temp - (temp % 100);
    return (temp/1000) + " K";
  } else if (temp > 1000) {
    var hun = Math.round(temp%1000).toString();
    var sig = Math.round((temp - hun)/1000);
    if (hun.length == 1)
        hun = "00" + hun;
    else if (hun.length == 2)
        hun = "0" + hun;
    return sig + "," + hun + " mK";
  } else {
    temp = temp.toFixed(2);
    return temp + " mK";
  }
}

// The fridges to sparkline
class FridgeSparkLine {
  fridge_name;
  fridge_db_name;
  fridge_js_name;
  txt_color;
  color;
  constructor(fridge_name, fridge_db_name, fridge_js_name, txt_color, color) {
    this.fridge_name = fridge_name;
    this.fridge_db_name = fridge_db_name;
    this.fridge_js_name = fridge_js_name;
    this.txt_color = txt_color;
    this.color = color;
  }

  data_uri() {
    var data_uri = new URL($.data_uri);
    data_uri.pathname += this.fridge_db_name + "/data/";
    data_uri.searchParams.set("summary", "");
    return data_uri.toString();
  }
}

// To add a new fridge, add a new SparkLine configuration below.
fridge_sparklines = [
  new FridgeSparkLine("Blue Fridge", "Blue_Fridge", "blue-fridge", "txt-color-blue", "#BCCFD7"),
  new FridgeSparkLine("Red Fridge", "Red_Fridge", "red-fridge", "txt-color-red", "#DD9AA9"),
  new FridgeSparkLine("Green Fridge", "Green_Fridge", "green-fridge", "txt-color-greenDark", "#B6C3B6"),
  new FridgeSparkLine("BlueFors LD", "BlueFors_LD", "ld", "txt-color-blueLight", "#DEF6FF"),
  new FridgeSparkLine("BlueFors XLD", "BlueFors_XLD", "xld", "txt-color-blueDarkBright", "#7FB6FF"),
  new FridgeSparkLine("Friesland", "Friesland", "friesland", "txt-color-teal", "#8FE6E4"),
  new FridgeSparkLine("Murphy", "Murphy", "murphy", "txt-color-teal", "#8FE6E4"),
]

  $(() => {
    // Initialize sparklines
    fridge_sparklines.forEach(fridge => {
      // Create sparklines for each fridge
      var li = document.createElement("li");
      li.setAttribute("class", "sparks-info");
      li.innerHTML = `
        <h5> ${fridge.fridge_name} <span class="${fridge.txt_color}" id="${fridge.fridge_js_name}-summary-text"><small>Loading...</small></span></h5>
        <div id="${fridge.fridge_js_name}-summary" class="sparkline ${fridge.txt_color} hidden-mobile hidden-md hidden-sm" data-sparkline-type="line" data-fill-color="${fridge.color}">
          <i class="fa-solid fa-spinner fa-spin"></i>
        </div>
      `;
      $("ul#sparks")[0].appendChild(li);

      $.getJSON(fridge.data_uri() , data => {
        $("#"+fridge.fridge_js_name+"-summary-text").text(format_temp(data[data.length-1], 1));
        init_sparkline($("#"+fridge.fridge_js_name+"-summary"), data);
      });
      setInterval(() => {
        $.getJSON(fridge.data_uri(), data => {
          var options = $("#"+fridge.fridge_js_name+"-summary")[0].sparkoptions;
          $("#"+fridge.fridge_js_name+"-summary-text").text(format_temp(data[data.length-1], 1));
          $("#"+fridge.fridge_js_name+"-summary").sparkline(data, options);
        });
      }, 5000);
    });
  });
</script>
