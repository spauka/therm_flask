<div class="row">
  <div class="col-xs-12 col-sm-7 col-md-7 col-lg-4">
    <h1 class="page-title txt-color-blueDark">
      <i class="fa-solid fa-chart-area fa-fw "></i> 
        Thermometry 
        <span>>
        {{$route.current.scope.pagetitle}}
      </span>
    </h1>
  </div>
  <div class="col-xs-12 col-sm-5 col-md-5 col-lg-8">
    <ul id="sparks" class="">
      <!-- Will be filled in by JS below -->
   </ul>
  </div>
</div>

<script type="text/javascript">
function format_temp(temp, multiplier) {
  if (temp == null) {
    return "Und";
  }
  temp *= multiplier;
  if (temp > 100000) {
    temp = Math.round(temp);
    temp = temp - (temp % 100);
    return (temp/1000) + " K";
  } else if (temp > 1000) {
    var hun = Math.round(temp%1000).toString();
    var sig = Math.round((temp - hun)/1000);
    if (hun.length == 1)
        hun = "00" + hun;
    else if (hun.length == 2)
        hun = "0" + hun;
    return sig + "," + hun + " mK";
  } else {
    temp = temp.toFixed(2);
    return temp + " mK";
  }
}

// The fridges to sparkline
class FridgeSparkLine {
  fridge_name;
  fridge_db_name;
  fridge_js_name;
  txt_color;
  color;
  multiplier;
  constructor(fridge_name, fridge_db_name, fridge_js_name, txt_color, color, multiplier) {
    this.fridge_name = fridge_name;
    this.fridge_db_name = fridge_db_name;
    this.fridge_js_name = fridge_js_name;
    this.txt_color = txt_color;
    this.color = color;
    this.multiplier = multiplier;
  }

  data_uri() {
    var data_uri = new URL($.data_uri);
    data_uri.pathname += this.fridge_db_name + "/data/";
    data_uri.searchParams.set("summary", "");
    return data_uri.toString();
  }
}

// To add a new fridge, add a new SparkLine configuration below.
fridge_sparklines = [
  new FridgeSparkLine("Blue Fridge", "Blue_Fridge", "blue-fridge", "txt-color-blue", "#BCCFD7", 1),
  new FridgeSparkLine("Red Fridge", "Red_Fridge", "red-fridge", "txt-color-red", "#DD9AA9", 1),
  new FridgeSparkLine("Green Fridge", "Green_Fridge", "green-fridge", "txt-color-greenDark", "#B6C3B6", 1),
  new FridgeSparkLine("BlueFors LD", "BlueFors_LD", "ld", "txt-color-blueLight", "#7ab6cc", 1000),
  new FridgeSparkLine("BlueFors XLD", "BlueFors_XLD", "xld", "txt-color-blueDarkBright", "#7FB6FF", 1000),
  new FridgeSparkLine("Friesland", "Friesland", "friesland", "txt-color-teal", "#8FE6E4", 1000),
  new FridgeSparkLine("Murphy", "Murphy", "murphy", "txt-color-teal", "#8FE6E4", 1000),
]

fridge_sparklines.forEach(fridge => {
    var li = document.createElement("li");
    li.setAttribute("class", "sparks-info");
    li.innerHTML = `
      <h5> ${fridge.fridge_name} <span class="${fridge.txt_color}" id="${fridge.fridge_js_name}-summary-text"><small>Loading...</small></span></h5>
      <div id="${fridge.fridge_js_name}-summary" class="sparkline ${fridge.txt_color} hidden-mobile hidden-md hidden-sm" data-sparkline-type="line" data-fill-color="${fridge.color}">
        <i class="fa-solid fa-spinner fa-spin"></i>
      </div>
    `;
    $("ul#sparks")[0].appendChild(li);
    const temp_label = "#"+fridge.fridge_js_name+"-summary-text";
    const temp_line = "#"+fridge.fridge_js_name+"-summary";

    $.getJSON(fridge.data_uri() , data => {
      
      // Set the temperature label
      $(temp_label).text(format_temp(data[data.length-1], fridge.multiplier));

      // Create sparkline
      const customOptions = {
        series: [{
          data: data,
          color: fridge.color,
        }],
        tooltip: {
          headerFormat: '',
          pointFormatter: function () {
            formatted_temp = format_temp(this.y, fridge.multiplier);
            return `<b>${formatted_temp}</b>`;
          }
        }
      };
      let chart_options = Highcharts.merge(defaultSparkStyle, customOptions);
      let chart = $(temp_line).highcharts("Chart", chart_options);

      // Create a callback to update every 10s
      setInterval(() => {
        $.getJSON(fridge.data_uri(), data => {
          // Set the temperature label
          $(temp_label).text(format_temp(data[data.length-1], fridge.multiplier));
          $(temp_line).highcharts().series[0].setData(data);
        })
      }, 10000);
    });
  }
)
</script>
